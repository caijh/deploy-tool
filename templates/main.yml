---
- name: Upload files
  copy:
    src: files/
    dest: "{{ upload_remote_dir }}/{{ role_name }}"

- name: Check to Install or Upgrade
  script: files/check.sh
  register: check_result

- name: Install when check_result is New
  script: files/install.sh
  when: check_result.stdout=='New'

- name: Backup when check_result is Upgrade
  script: files/backup.sh
  when: check_result.stdout=='Upgrade'

- name: Upgrade when check_result is upgrade
  script: files/upgrade.sh
  when: check_result.stdout=='Upgrade'

- name: Test, Invoke auto test scripts
  script: files/test.sh
  register: test_result
  ignore_errors: True

- name: Rollback Install when auto test fail
  script: files/new-rollback.sh
  when: test_result.rc > 0 and check_result.stdout=='New'

- name: Rollback Upgrade when auto test fail
  script: files/upgrade-rollback.sh
  when: test_result.rc > 0 and check_result.stdout=='Upgrade'